name: Continuous Integration

on:
  push:
  pull_request:

permissions:
  contents: read  #  to fetch code (actions/checkout)

jobs:
  linux:
    name: Linux (.NET 6.0)
    runs-on: ubuntu-22.04

    steps:
      - name: Clone Repository
        uses: actions/checkout@v3

      - name: Install .NET 6.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Prepare Environment
        run: |
          . mod.config;
          awk '/\r$$/ { exit(1); }' mod.config || (printf "Invalid mod.config format. File must be saved using unix-style (LF, not CRLF or CR) line endings.\n"; exit 1);

      - name: Check Code
        run: |
          make
          make check-packaging-scripts

      - name: Check Mod
        run: |
          sudo apt-get install lua5.1
          make check-scripts

  linux-mono:
    name: Linux (mono)
    runs-on: ubuntu-22.04

    steps:
      - name: Clone Repository
        uses: actions/checkout@v3

      - name: Prepare Environment
        run: |
          . mod.config;
          awk '/\r$$/ { exit(1); }' mod.config || (printf "Invalid mod.config format. File must be saved using unix-style (LF, not CRLF or CR) line endings.\n"; exit 1);

      - name: Check Code
        run: |
          # check-packaging-scripts does not depend on .net/mono, so is not needed here
          mono --version
          make RUNTIME=mono

  smoke-test:
    name: Game Smoke Test
    runs-on: ubuntu-22.04

    steps:
      - name: Clone Repository
        uses: actions/checkout@v3

      - name: Install .NET 6.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Prepare Environment
        run: |
          . mod.config;
          awk '/\r$$/ { exit(1); }' mod.config || (printf "Invalid mod.config format. File must be saved using unix-style (LF, not CRLF or CR) line endings.\n"; exit 1);

      - name: Build Mod
        run: make

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb pulseaudio curl jq

      - name: Run Smoke Test
        timeout-minutes: 5
        run: |
          # Start virtual display for headless execution
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          export DISPLAY=:99

          # Start pulseaudio for audio (prevents crashes)
          pulseaudio --start --exit-idle-time=-1 > /dev/null 2>&1 || true

          # Create empty Content directory to prevent modcontent prompts
          # The CA mod expects optional content packages that aren't available in CI
          # Creating an empty directory prevents the content installer from blocking startup
          mkdir -p ~/.config/openra/Content/ca

          # Make script executable
          chmod +x test-game-smoke.sh

          # Run smoke test
          ./test-game-smoke.sh

      - name: Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: /tmp/openra-smoke-test.log
          retention-days: 7

  windows:
    name: Windows (.NET 6.0)
    runs-on: windows-latest

    steps:
      - name: Clone Repository
        uses: actions/checkout@v3

      - name: Install .NET 6.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Check Code
        shell: powershell
        run: |
          # Work around runtime failures on the GH Actions runner
          dotnet nuget add source https://api.nuget.org/v3/index.json -n nuget.org
          .\make.ps1 check
